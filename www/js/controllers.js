// Generated by CoffeeScript 1.9.1
(function() {
  var app, chunk, dataURItoBlob;

  chunk = function(arr, size) {
    var i, newArr;
    newArr = [];
    i = 0;
    while (i < arr.length) {
      newArr.push(arr.slice(i, i + size));
      i += size;
    }
    return newArr;
  };

  dataURItoBlob = function(dataURI) {
    var array, binary, i;
    binary = atob(dataURI.split(',')[1]);
    array = [];
    i = 0;
    while (i < binary.length) {
      array.push(binary.charCodeAt(i));
      i++;
    }
    return new Blob([new Uint8Array(array)], {
      type: 'image/jpeg'
    });
  };

  app = angular.module('app');

  app.filter('splitParagraphs', function() {
    return function(text) {
      return text.split('\n');
    };
  });

  app.filter('splitWords', function() {
    return function(text) {
      return text.split(' ');
    };
  });

  app.controller('AppCtrl', [
    "$scope", "$ionicModal", "$rootScope", "$timeout", "$kinvey", "kinveyKey", "kinveySecret", function($scope, $ionicModal, $rootScope, $timeout, $kinvey, kinveyKey, kinveySecret) {
      var promise;
      console.log('in app ctrl');
      $scope.loginData = {};
      $scope.signupData = {};
      $ionicModal.fromTemplateUrl("templates/login.html", {
        scope: $scope
      }).then(function(loginmodal) {
        $scope.loginmodal = loginmodal;
      });
      $ionicModal.fromTemplateUrl("templates/signup.html", {
        scope: $scope
      }).then(function(signupmodal) {
        $scope.signupmodal = signupmodal;
      });
      promise = $kinvey.init({
        appKey: kinveyKey,
        appSecret: kinveySecret,
        sync: {
          enable: true
        }
      });
      promise.then(function(kinveyUser) {
        $rootScope.getUserBooks = function() {
          var query;
          $rootScope.books = [];
          query = new $kinvey.Query();
          query.contains("sharedWith", [$rootScope.activeUser._id]);
          promise = $kinvey.DataStore.find("Books", query);
          return promise.then(function(books) {
            return $rootScope.books = books;
          });
        };
        $scope.openLogin = function() {
          $scope.loginmodal.show();
        };
        $scope.closeLogin = function() {
          $scope.loginmodal.hide();
        };
        $scope.closeSignup = function() {
          $scope.signupmodal.hide();
        };
        $scope.openSignup = function() {
          var getAllLanguages;
          $scope.loginmodal.hide();
          getAllLanguages = function() {
            promise = $kinvey.DataStore.find('Languages');
            return promise.then(function(listOfLanguages) {
              $scope.listOfLanguages = listOfLanguages;
              $scope.signupmodal.show();
              return listOfLanguages;
            });
          };
          if ($kinvey.getActiveUser()) {
            return getAllLanguages();
          } else {
            promise = $kinvey.User.login({
              username: "user",
              password: "password"
            });
            return promise.then(function(tempUser) {
              return getAllLanguages();
            });
          }
        };
        $scope.logout = function() {
          return $kinvey.User.logout().then(function() {
            $rootScope.activeUser === null;
            $scope.openLogin();
          });
        };
        $scope.doLogin = function() {
          var logIntoKinvey;
          logIntoKinvey = function() {
            promise = $kinvey.User.login({
              username: $scope.loginData.username.toLowerCase(),
              password: $scope.loginData.password
            });
            return promise.then(function(activeUser) {
              $rootScope.activeUser = activeUser;
              $rootScope.getUserBooks().then(function() {
                var loginEvent;
                loginEvent = 'loginEvent';
                $scope.$broadcast(loginEvent);
                return $scope.closeLogin();
              });
            });
          };
          if ($kinvey.getActiveUser()) {
            return $kinvey.User.logout().then(function() {
              return logIntoKinvey();
            });
          } else {
            return logIntoKinvey();
          }
        };
        $scope.doSignup = function() {
          var logoutPromise;
          logoutPromise = $kinvey.User.logout();
          return logoutPromise.then(function() {
            var formData, signup_promise;
            formData = {
              username: $scope.signupData.username.toLowerCase(),
              password: $scope.signupData.password,
              email: $scope.signupData.username.toLowerCase(),
              language: $scope.signupData.language._id,
              speed: 1
            };
            signup_promise = $kinvey.User.signup(formData);
            return signup_promise.then(function(activeUser) {
              $rootScope.activeUser = activeUser;
              return $rootScope.getUserBooks().then(function() {
                var loginEvent;
                loginEvent = 'loginEvent';
                $scope.$broadcast(loginEvent);
                return $scope.closeSignup();
              });
            });
          });
        };
        if (kinveyUser) {
          if (kinveyUser.username === "user") {
            $scope.openLogin();
          } else {
            $rootScope.activeUser = kinveyUser;
            return $rootScope.getUserBooks().then(function() {
              var loginEvent;
              loginEvent = 'loginEvent';
              $scope.$broadcast(loginEvent);
            });
          }
        } else {
          $scope.openLogin();
        }
      });
    }
  ]);

  app.controller('ReadCtrl', [
    "$rootScope", "$scope", "$kinvey", "$stateParams", "$location", function($rootScope, $scope, $kinvey, $stateParams, $location) {
      console.log('in read ctrl');
      $scope.redirectToEdit = function(editUrl) {
        return $location.path(editUrl);
      };
      $scope.$on('loginEvent', function() {
        var add_book, books_to_chunk;
        add_book = {
          coverImageUrl: "img/add_book_icon.jpg",
          add_url: "add"
        };
        books_to_chunk = $scope.books;
        books_to_chunk.unshift(add_book);
        $rootScope.libraryLayout = chunk(books_to_chunk, 3);
      });
    }
  ]);

  app.controller('PlayerCtrl', [
    "$kinvey", "$location", "$scope", "$stateParams", "$rootScope", "$ionicSlideBoxDelegate", "$http", function($kinvey, $location, $scope, $stateParams, $rootScope, $ionicSlideBoxDelegate, $http) {
      var bookPromise, defineUtterance1, defineUtterance2, pageQuery, playUtterance;
      pageQuery = new $kinvey.Query();
      pageQuery.equalTo('bookId', $stateParams.bookId);
      bookPromise = $kinvey.DataStore.get("Books", $stateParams.bookId);
      bookPromise.then(function(book) {
        var promise;
        $scope.book = book;
        promise = $kinvey.DataStore.find("Pages", pageQuery);
        return promise.then(function(pages) {
          var book_display_data;
          book_display_data = {
            image: {
              _downloadURL: book.coverImageUrl
            },
            text: book.title + " by " + book.author
          };
          pages.unshift(book_display_data);
          $scope.pages = pages;
          $ionicSlideBoxDelegate.update();
          promise = $kinvey.DataStore.get('Languages', $rootScope.activeUser.language);
          return promise.then(function(translationLanguage) {
            return $scope.translationLanguage = translationLanguage;
          });
        });
      });
      $scope.currentSlide = 0;
      $scope.playing = false;
      playUtterance = new SpeechSynthesisUtterance;
      defineUtterance1 = new SpeechSynthesisUtterance;
      defineUtterance2 = new SpeechSynthesisUtterance;
      playUtterance.onend = function() {
        $scope.$apply(function() {
          $scope.playing = false;
        });
      };
      playUtterance.onpause = function() {};
      defineUtterance1.onend = function() {
        speechSynthesis.speak(defineUtterance2);
      };
      $scope.slideHasChanged = function(newSlide) {
        $scope.currentSlide = newSlide;
      };
      $scope.slideTo = function(slideNum) {
        speechSynthesis.cancel();
        $scope.playing = false;
        return $ionicSlideBoxDelegate.slide(slideNum);
      };
      $scope.slidePrevious = function() {
        speechSynthesis.cancel();
        $scope.playing = false;
        $ionicSlideBoxDelegate.previous();
      };
      $scope.slideNext = function() {
        speechSynthesis.cancel();
        $scope.playing = false;
        $ionicSlideBoxDelegate.next();
      };
      $scope.speak = function(text, lang) {
        $scope.playing = true;
        if (speechSynthesis.speaking === true) {
          speechSynthesis.resume();
        } else {
          playUtterance.text = text;
          playUtterance.lang = lang;
          playUtterance.localService = true;
          console.log(speechSynthesis);
          console.log(playUtterance);
          speechSynthesis.speak(playUtterance);
        }
      };
      $scope.pause = function() {
        speechSynthesis.cancel();
        $scope.playing = false;
      };
      $scope.endBook = function() {
        speechSynthesis.cancel();
        $scope.playing = false;
      };
      $scope.define = function(word) {
        var link, selected_word;
        selected_word = word.trim().replace(/["\.,-\/#!$%\^&\*;:{}=\-_`~()]/g, "");
        link = "https://translation-app.herokuapp.com/api/en/" + $scope.translationLanguage._id + "/" + selected_word;
        $http.get(link).success(function(translated_word, status, headers, config) {
          $scope.selected_word = selected_word;
          $scope.translated_word = translated_word;
          defineUtterance1.text = $scope.selected_word;
          defineUtterance1.lang = "en";
          defineUtterance1.localService = true;
          defineUtterance2.text = $scope.translated_word;
          defineUtterance2.lang = $scope.translationLanguage._id;
          defineUtterance2.localService = true;
          speechSynthesis.speak(defineUtterance1);
        }).error(function(data, status, headers, config) {
          return 'error';
        });
      };
    }
  ]);

  app.controller('SettingsCtrl', [
    "$ionicHistory", "$scope", "$kinvey", "$rootScope", "$ionicPopup", function($ionicHistory, $scope, $kinvey, $rootScope, $ionicPopup) {
      var promise;
      promise = $kinvey.DataStore.find('Languages');
      promise.then(function(listOfLanguages) {
        $scope.listOfLanguages = listOfLanguages;
      });
      $scope.goBack = function() {
        $ionicHistory.goBack();
      };
      $scope.updateUser = function() {
        promise = $kinvey.User.update($rootScope.activeUser);
        return promise.then(function() {
          var alertPopup;
          alertPopup = $ionicPopup.alert({
            title: 'SAVED'
          });
        });
      };
    }
  ]);

  app.controller('EditCtrl', function($scope) {
    $scope.settings = {
      enableFriends: true
    };
  });

  app.controller('ReviewCtrl', [
    "$scope", "$ionicPopup", function($scope, $ionicPopup) {
      console.log('in review ctrl');
      $scope.vocablist = [
        {
          english: 'ROAD',
          defn: 'camino',
          book: 'ginger'
        }, {
          english: 'LOSE',
          defn: 'perder',
          book: 'hansel'
        }, {
          english: 'PLACE',
          defn: 'lugar',
          book: 'hansel'
        }, {
          english: 'OUTSIDE',
          defn: 'afuera',
          book: 'hansel'
        }, {
          english: 'RUN',
          defn: 'correr',
          book: 'ginger'
        }
      ];
      $scope.bookList = function(title, biglist) {
        var k, len, thisList, word;
        thisList = [];
        for (k = 0, len = biglist.length; k < len; k++) {
          word = biglist[k];
          if (title === word.book) {
            thisList.push(word);
          }
        }
        return thisList;
      };
      $scope.hanselList = $scope.bookList("hansel", $scope.vocablist);
      $scope.gingerList = $scope.bookList("ginger", $scope.vocablist);
      return $scope.showPopup = function(vocab) {
        var alertPopup;
        console.log('in showPopup function' + vocab);
        alertPopup = $ionicPopup.alert({
          title: vocab.english,
          subTitle: vocab.defn,
          template: '(sentence in context)'
        });
      };
    }
  ]);

  app.controller('PracticeCtrl', [
    "$ionicHistory", "$scope", "$kinvey", "$rootScope", "$ionicPopup", "$stateParams", "$location", function($ionicHistory, $scope, $kinvey, $rootScope, $ionicPopup, $stateParams, $location) {
      var joinAnswers, shuffle, wrongAnswers;
      $scope.goBack = function() {
        $ionicHistory.goBack();
      };
      $scope.answer = {
        eng: 'milk',
        correct: true,
        defn: 'leche'
      };
      wrongAnswers = [
        {
          eng: 'napkin',
          correct: false,
          defn: 'servilleta'
        }, {
          eng: 'lose',
          correct: false,
          defn: 'perder'
        }, {
          eng: 'place',
          correct: false,
          defn: 'lugar'
        }, {
          eng: 'outside',
          correct: false,
          defn: 'afuera'
        }
      ];
      shuffle = function(a) {
        var i, j, t;
        i = a.length;
        while (--i > 0) {
          j = ~~(Math.random() * (i + 1));
          t = a[j];
          a[j] = a[i];
          a[i] = t;
        }
        return a;
      };
      joinAnswers = function(wrongList, rightAnswer) {
        wrongList.push(rightAnswer);
        shuffle(wrongList);
        return wrongList;
      };
      $scope.possibleAnswers = joinAnswers(wrongAnswers, $scope.answer);
      $scope.questionNum = $stateParams.practiceNum;
      $scope.blockList = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
      return $scope.showResult = function(word) {
        var alertPopup, correctPopup, nextPageNum;
        console.log('in showResult function');
        if (word.correct) {
          nextPageNum = parseInt($stateParams.practiceNum);
          nextPageNum += 1;
          if (nextPageNum > 9) {
            return alertPopup = $ionicPopup.alert({
              title: "PRACTICE DONE!",
              template: "Congratulations!"
            });
          } else {
            return correctPopup = $ionicPopup.show({
              title: "Good Job!",
              template: word.eng + ' = ' + word.defn,
              buttons: [
                {
                  text: 'Next',
                  onTap: function() {
                    return $location.path("/practice/" + nextPageNum.toString());
                  }
                }
              ]
            });
          }
        } else {
          return alertPopup = $ionicPopup.alert({
            title: "Try again!",
            template: word.eng + ' = ' + word.defn
          });
        }
      };
    }
  ]);

  app.controller('AddCtrl', [
    "$rootScope", "$scope", "Camera", "uploadContent", "$ionicHistory", "Library", function($rootScope, $scope, Camera, uploadContent, $ionicHistory, Library) {
      var imageStr;
      $scope.book = {};
      imageStr = "";
      $scope.goBack = function() {
        return $rootScope.getUserBooks().then(function() {
          $rootScope.libraryLayout = Library.getShelf($rootScope.books);
          return $ionicHistory.goBack();
        });
      };
      $scope.getPhoto = function() {
        var options;
        options = {
          quality: 50,
          destinationType: navigator.camera.DestinationType.DATA_URL,
          encodingType: navigator.camera.EncodingType.JPEG
        };
        Camera.getPicture(options).then((function(imageStr) {
          $scope.book.image = "data:image/jpeg;base64," + imageStr;
          $scope.book.imageBlob = dataURItoBlob($scope.book.image);
        }), (function(err) {
          console.err(err);
        }));
      };
      return $scope.addBook = function() {
        var imgBlob;
        imgBlob = $scope.book.imageBlob;
        uploadContent.uploadFile({
          "image": imgBlob,
          "size": imgBlob.size
        }).then((function(fileInfo) {
          var data;
          data = {
            title: $scope.book.title,
            author: $scope.book.author,
            coverImageFile: fileInfo,
            sharedWith: [$rootScope.activeUser._id]
          };
          return uploadContent.uploadModel("Books", data).then(function(uploaded_file) {});
        }), (function(err) {
          return console.log(err);
        }));
      };
    }
  ]);

  app.controller('EditBookCtrl', [
    "$ionicHistory", "$scope", "$kinvey", "$rootScope", "$stateParams", "Camera", "uploadContent", "$location", "$state", "Library", function($ionicHistory, $scope, $kinvey, $rootScope, $stateParams, Camera, uploadContent, $location, $state, Library) {
      var bookPromise, pageQuery;
      console.log('in edit book ctrl');
      pageQuery = new $kinvey.Query();
      pageQuery.equalTo('bookId', $stateParams.bookId);
      bookPromise = $kinvey.DataStore.get("Books", $stateParams.bookId);
      bookPromise.then(function(book) {
        var promise;
        $scope.book = book;
        pageQuery = new $kinvey.Query();
        pageQuery.equalTo('bookId', $stateParams.bookId);
        promise = $kinvey.DataStore.find("Pages", pageQuery);
        return promise.then(function(pages) {
          var add_page_data;
          add_page_data = {
            image: {
              _downloadURL: "img/add_book_icon.jpg"
            },
            text: ""
          };
          pages.push(add_page_data);
          $scope.pages = pages;
        });
      });
      $scope.getPhoto = function() {
        var options;
        options = {
          quality: 50,
          destinationType: navigator.camera.DestinationType.DATA_URL,
          encodingType: navigator.camera.EncodingType.JPEG
        };
        Camera.getPicture(options).then((function(imageStr) {
          $scope.book.image = "data:image/jpeg;base64," + imageStr;
          $scope.book.imageBlob = dataURItoBlob($scope.book.image);
        }), (function(err) {
          console.err(err);
        }));
      };
      $scope.goBack = function() {
        return $rootScope.getUserBooks().then(function() {
          $rootScope.libraryLayout = Library.getShelf($rootScope.books);
          return $ionicHistory.goBack();
        });
      };
      $scope.updateBook = function() {
        var imgBlob;
        if ($scope.book.imageBlob) {
          imgBlob = $scope.book.imageBlob;
        }
        delete $scope.book.image;
        delete $scope.book.imageBlob;
        if (imgBlob) {
          uploadContent.uploadFile({
            "image": imgBlob,
            "size": imgBlob.size
          }).then((function(fileInfo) {
            $scope.book.coverImageFile = fileInfo;
            return uploadContent.updateModel("Books", $scope.book).then(function(uploaded_file) {
              $scope.goBack();
            });
          }), (function(err) {
            return console.log(err);
          }));
          return;
        } else {
          uploadContent.updateModel("Books", $scope.book).then(function(uploaded_file) {
            $scope.goBack();
          });
        }
      };
      return $scope.deleteBook = function() {
        uploadContent.deleteModel("Books", $scope.book._id).then(function() {
          $scope.goBack();
        });
      };
    }
  ]);

  app.controller('EditPageCtrl', [
    "$ionicHistory", "$scope", "$kinvey", "$rootScope", "$stateParams", "$ionicSlideBoxDelegate", "uploadContent", "Pages", function($ionicHistory, $scope, $kinvey, $rootScope, $stateParams, $ionicSlideBoxDelegate, uploadContent, Pages) {
      var bookPromise, pageQuery;
      $scope.currentSlide = $stateParams.pageNum;
      pageQuery = new $kinvey.Query();
      pageQuery.equalTo('bookId', $stateParams.bookId);
      bookPromise = $kinvey.DataStore.get("Books", $stateParams.bookId);
      bookPromise.then(function(book) {
        var promise;
        $scope.book = book;
        promise = $kinvey.DataStore.find("Pages", pageQuery);
        return promise.then(function(pages) {
          var add_page_data;
          add_page_data = {
            image: {
              _downloadURL: "img/add_book_icon.jpg"
            },
            text: ""
          };
          pages.push(add_page_data);
          $scope.pages = pages;
          $ionicSlideBoxDelegate.update();
          return $ionicSlideBoxDelegate.slide($stateParams.pageNum);
        });
      });
      $scope.goBack = function() {
        $scope.pages = Pages.getPages($scope.book._id);
        $ionicHistory.goBack();
      };
      $scope.slideHasChanged = function(newSlide) {
        $scope.currentSlide = newSlide;
      };
      $scope.slideTo = function(slideNum) {
        return $ionicSlideBoxDelegate.slide(slideNum);
      };
      $scope.slidePrevious = function() {
        $ionicSlideBoxDelegate.previous();
      };
      $scope.slideNext = function() {
        $ionicSlideBoxDelegate.next();
      };
      $scope.changeImage = function(index) {};
      return $scope.saveChanges = function(index) {
        var newPage, updatedPage, updatedText;
        updatedPage = $scope.pages[index];
        console.log(updatedPage);
        if (index === $scope.pages.length - 1) {
          updatedText = updatedPage.text;
          newPage = {
            "bookId": $scope.book._id,
            "text": updatedText,
            "pageNumber": index
          };
          uploadContent.uploadModel("Pages", newPage).then(function(uploaded_page) {});
        } else {
          uploadContent.updateModel("Pages", updatedPage).then(function(uploaded_page) {});
        }
      };
    }
  ]);

}).call(this);
